<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.business.mapper.DataPoolItem.DataPoolItemMapper">
    
    <resultMap type="DataPoolItem" id="DataPoolItemResult">
        <result property="id"           column="id"           />
        <result property="poolId"       column="pool_id"      />
        <result property="itemData"     column="item_data"    />
        <result property="status"       column="status"       />
        <result property="printCount"   column="print_count"  />
        <result property="deviceId"     column="device_id"      />
        <result property="receivedTime" column="received_time"/>
        <result property="delFlag"      column="del_flag"     />
        <result property="createTime"   column="create_time"  />
        <result property="updateTime"   column="update_time"  />
    </resultMap>

    <sql id="selectDataPoolItemVo">
        select id, pool_id, item_data, status, print_count, device_id, received_time, del_flag, create_time, update_time
        from data_pool_item
    </sql>

    <select id="selectDataPoolItemList" parameterType="DataPoolItem" resultMap="DataPoolItemResult">
        <include refid="selectDataPoolItemVo"/>
        <where>  
            del_flag = '0'
            <if test="poolId != null">and pool_id = #{poolId}</if>
            <if test="itemData != null and itemData != ''">and item_data like concat('%', #{itemData}, '%')</if>
            <if test="status != null and status != ''">and status = #{status}</if>
            <if test="printCount != null">and print_count = #{printCount}</if>
            <if test="deviceId != null and deviceId != ''">and device_id = #{deviceId}</if>
            <if test="receivedTime != null">and received_time = #{receivedTime}</if>
        </where>
        order by received_time desc
    </select>
    
    <select id="selectDataPoolItemById" parameterType="Long" resultMap="DataPoolItemResult">
        <include refid="selectDataPoolItemVo"/>
        where id = #{id} and del_flag = '0'
    </select>

    <select id="selectDataPoolItemByPoolId" parameterType="Long" resultMap="DataPoolItemResult">
        <include refid="selectDataPoolItemVo"/>
        where pool_id = #{poolId} and del_flag = '0'
        order by received_time desc
    </select>

    <select id="selectDataPoolItemByStatus" parameterType="String" resultMap="DataPoolItemResult">
        <include refid="selectDataPoolItemVo"/>
        where status = #{status} and del_flag = '0'
        order by received_time asc
    </select>

    <select id="selectPendingItems" resultMap="DataPoolItemResult">
        <include refid="selectDataPoolItemVo"/>
        where status = 'PENDING' and del_flag = '0'
        <if test="poolId != null">and pool_id = #{poolId}</if>
        order by received_time asc
        <if test="limit != null">limit #{limit}</if>
    </select>

    <!-- 分页查询待打印数据项 -->
    <select id="selectPendingItemsPage" parameterType="com.ruoyi.business.domain.DataPoolItem.DataPoolItem" resultMap="DataPoolItemResult">
        <include refid="selectDataPoolItemVo"/>
        where del_flag = '0'
        <if test="status != null">and status = #{status}</if>
        <if test="poolId != null">and pool_id = #{poolId}</if>
        <if test="deviceId != null and deviceId != ''">and device_id = #{deviceId}</if>
        <if test="itemData != null and itemData != ''">and item_data like concat('%', #{itemData}, '%')</if>
        <if test="printCount != null">and print_count = #{printCount}</if>
        <if test="receivedTime != null">and received_time = #{receivedTime}</if>
        order by received_time asc
    </select>

    <update id="lockDataPoolItem">
        update data_pool_item
        set status = 'PRINTING',
            device_id = #{deviceId},
            update_time = now()
        where id = #{id} 
          and status = 'PENDING' 
          and del_flag = '0'
    </update>

    <update id="batchLockDataPoolItems">
        update data_pool_item
        set status = 'PRINTING',
            device_id = #{deviceId},
            update_time = now()
        where id in
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
        and status = 'PENDING' 
        and del_flag = '0'
    </update>

    <update id="updateDataPoolItemStatus">
        update data_pool_item
        set status = #{status},
            <if test="printCount != null">print_count = #{printCount},</if>
            update_time = now()
        where id = #{id} and del_flag = '0'
    </update>

    <update id="releaseLock">
        update data_pool_item
        set status = 'PENDING',
            device_id = null,
            update_time = now()
        where id = #{id} and del_flag = '0'
    </update>

    <update id="releaseLockByLockId">
        update data_pool_item
        set status = 'PENDING',
            device_id = null,
            update_time = now()
        where device_id = #{deviceId} and del_flag = '0'
    </update>

    <insert id="insertDataPoolItem" parameterType="DataPoolItem" useGeneratedKeys="true" keyProperty="id">
        insert into data_pool_item
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="poolId != null">pool_id,</if>
            <if test="itemData != null and itemData != ''">item_data,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="printCount != null">print_count,</if>
            <if test="deviceId != null">device_id,</if>
            <if test="receivedTime != null">received_time,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="poolId != null">#{poolId},</if>
            <if test="itemData != null and itemData != ''">#{itemData},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="printCount != null">#{printCount},</if>
            <if test="deviceId != null">#{deviceId},</if>
            <if test="receivedTime != null">#{receivedTime},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <insert id="batchInsertDataPoolItems" parameterType="java.util.List">
        insert into data_pool_item (pool_id, item_data, status, print_count, received_time, del_flag, create_time, update_time)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.poolId}, #{item.itemData}, #{item.status}, #{item.printCount}, #{item.receivedTime}, #{item.delFlag}, #{item.createTime}, #{item.updateTime})
        </foreach>
    </insert>

    <update id="updateDataPoolItem" parameterType="DataPoolItem">
        update data_pool_item
        <trim prefix="SET" suffixOverrides=",">
            <if test="poolId != null">pool_id = #{poolId},</if>
            <if test="itemData != null and itemData != ''">item_data = #{itemData},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="printCount != null">print_count = #{printCount},</if>
            <if test="deviceId != null">device_id = #{deviceId},</if>
            <if test="receivedTime != null">received_time = #{receivedTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id} and del_flag = '0'
    </update>
    <update id="updateDataPoolItemsStatus">
        update data_pool_item
        set status = #{status},
            device_id = #{deviceId}
        where id in
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
        and del_flag = '0'
    </update>
    <update id="updateItemsStatus">
        update data_pool_item
        set status = #{status}
        where id in
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
        and del_flag = '0'
    </update>
    <update id="updateToPendingItem">
        update data_pool_item
        set status = 'PENDING'
        where pool_id = #{poolId}
          and status = 'PRINTING'
        and del_flag = '0'
    </update>

    <delete id="deleteDataPoolItemById" parameterType="Long">
        update data_pool_item set del_flag = '2', update_time = now() where id = #{id}
    </delete>

    <delete id="deleteDataPoolItemByIds" parameterType="Long">
        update data_pool_item set del_flag = '2', update_time = now() where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteDataPoolItemByPoolId" parameterType="Long">
        update data_pool_item set del_flag = '2', update_time = now() where pool_id = #{poolId}
    </delete>

    <select id="countByStatus" resultType="java.util.Map">
        select status, count(*) as count
        from data_pool_item
        where del_flag = '0'
        <if test="poolId != null">and pool_id = #{poolId}</if>
        group by status
    </select>
    <select id="getCompletedCount" resultType="java.lang.Long">
        select count(*)
        from data_pool_item
        where status = #{status}
          and del_flag = '0'
        <if test="poolId != null">and pool_id = #{poolId}</if>
        <if test="deviceId != null">and device_id = #{deviceId}</if>
    </select>

    <select id="countByNotPending" parameterType="java.lang.Integer">
        select count(*)
        from data_pool_item
        where status != 'PENDING'
          and del_flag = '0'
        <if test="poolId != null">and pool_id = #{poolId}</if>
    </select>
    <select id="countIntStatus" resultType="java.lang.Integer">
        select count(*)
        from data_pool_item
        where status = #{status}
          and del_flag = '0'
        <if test="poolId != null">and pool_id = #{poolId}</if>
    </select>

    <delete id="cleanPrintedData">
        update data_pool_item 
        set del_flag = '2', update_time = now()
        where status = 'PRINTED' 
          and del_flag = '0'
        <if test="poolId != null">and pool_id = #{poolId}</if>
        <if test="beforeTime != null">and create_time &lt; #{beforeTime}</if>
    </delete>

</mapper>
